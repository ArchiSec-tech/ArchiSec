<!DOCTYPE html>
<html lang="it">
<head>
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-KFV46D4V');</script>
  <!-- End Google Tag Manager -->
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-BBHC6F9JTY"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-BBHC6F9JTY');
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Richiedi una consulenza - ArchiTech</title>
  <link rel="stylesheet" href="./vars.css" />
  <link rel="stylesheet" href="./style.css" />
  <script src="js/main.js" defer></script>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KFV46D4V"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
</head>
<body class="default-theme">
  <header class="site-header">
    <div class="site-container header-inner">
      <a href="index.html" class="site-brand">ArchiTech</a>
      <nav class="site-nav">
        <a href="scopri.html">Scopri di più</a>
        <a href="pricing.html">Pricing</a>
        <a href="contattaci.html">Contattaci</a>
      </nav>
    </div>
  </header>

  <main class="site-container site-main">
    <h1 class="gradient-title">Richiedi una consulenza</h1>
    <p class="lead">Hai bisogno di aiuto immediato o vuoi capire quale piano fa per te? Compila il modulo: ti ricontattiamo a breve.</p>

    <form class="form" netlify>
      <div class="field">
        <label for="azienda">Azienda</label>
        <input id="azienda" name="azienda" type="text" />
      </div>
      <div class="field">
        <label for="contatto">Nome e Cognome</label>
        <input id="contatto" name="contatto" type="text" required />
      </div>
      <div class="field">
        <label for="email">Email</label>
        <input id="email" name="email" type="email" required />
      </div>
      <div class="field">
        <label for="piano">Piano di interesse</label>
        <select id="piano" name="piano">
          <option value="start">Start</option>
          <option value="pro">Pro</option>
          <option value="enterprise">Enterprise</option>
          <option value="da-definire" selected>Da definire</option>
        </select>
      </div>
      <div class="field">
        <label for="note">Note</label>
        <textarea id="note" name="note" rows="5"></textarea>
      </div>
      <div class="actions">
        <button class="btn btn-primary" type="submit">Invia richiesta</button>
        <a class="btn btn-outline" href="pricing.html">Torna al Pricing</a>
      </div>
    </form>
  </main>

  <footer class="site-footer">
    <div class="site-container footer-inner">
      <span>© 2025 ArchiTech</span>
      <div class="footer-social">
        <img src="social0.svg" alt="Social 1" />
        <img src="social1.svg" alt="Social 2" />
        <img src="social2.svg" alt="Social 3" />
      </div>
    </div>
  </footer>

  <!-- Firebase Scripts (v8 compat) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  
  <!-- Firebase Config Loader -->
  <script src="js/firebase-config.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const consultationForm = document.getElementById('consultation-form');
      
      consultationForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Wait for Firebase to be ready
        await new Promise(resolve => setTimeout(resolve, 500));
        
        const authInstance = window.auth;
        const dbInstance = window.db;
        
        if (!authInstance || !dbInstance) {
          alert('Errore: Servizio non disponibile. Riprova tra qualche secondo.');
          return;
        }
        
        try {
          const currentUser = authInstance.currentUser;
          const formData = {
            azienda: document.getElementById('azienda').value,
            contatto: document.getElementById('contatto').value,
            email: document.getElementById('email').value,
            piano: document.getElementById('piano').value,
            note: document.getElementById('note').value,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            status: 'new',
            userId: currentUser ? currentUser.uid : null,
            userEmail: currentUser ? currentUser.email : document.getElementById('email').value
          };
          
          // Save to Firestore
          await dbInstance.collection('consultations').add(formData);
          
          alert('✅ Richiesta di consulenza inviata con successo! Ti contatteremo presto.');
          
          // Reset form
          consultationForm.reset();
          
          // Redirect after success
          setTimeout(() => {
            window.location.href = currentUser ? 'dashboard.html' : 'index.html';
          }, 2000);
          
        } catch (error) {
          console.error('Errore invio consulenza:', error);
          alert('❌ Errore durante l\'invio della richiesta. Riprova o contatta il supporto.');
        }
      });
    });
  </script>
</body>
</html>

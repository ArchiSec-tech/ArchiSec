#!/usr/bin/env node
const fs = require('fs');
const path = require('path');

const root = path.join(__dirname, '..');
const envPath = path.join(root, '.env');
const outPath = path.join(root, 'js', 'firebase-config.local.js');

if (!fs.existsSync(envPath)) {
  console.error('.env not found at', envPath);
  process.exit(1);
}

const raw = fs.readFileSync(envPath, 'utf8');

function parseKeyValue(text) {
  const map = {};
  const kvRe = /^\s*([A-Za-z0-9_]+)\s*=\s*"?([^"\n]+)"?\s*$/gm;
  let m;
  while ((m = kvRe.exec(text)) !== null) {
    map[m[1]] = m[2].trim();
  }
  return Object.keys(map).length ? map : null;
}

function parseJsObjectSnippet(text) {
  const keys = ['apiKey','authDomain','projectId','storageBucket','messagingSenderId','appId','measurementId'];
  const map = {};
  for (const k of keys) {
    const re = new RegExp(k + "\\s*[:=]\\s*['\"]([^'\"]+)['\"]", 'i');
    const m = re.exec(text);
    if (m) map[k] = m[1];
  }
  return Object.keys(map).length ? map : null;
}

let parsed = parseKeyValue(raw);
if (!parsed) parsed = parseJsObjectSnippet(raw);

if (!parsed) {
  console.error('Could not parse .env. Please use KEY=VALUE or include the firebase object snippet.');
  process.exit(2);
}

// Normalize keys if user used different names in KEY=VALUE
const map = {
  apiKey: parsed.FIREBASE_API_KEY || parsed.apiKey || parsed.API_KEY || parsed.APIKEY,
  authDomain: parsed.FIREBASE_AUTH_DOMAIN || parsed.authDomain,
  projectId: parsed.FIREBASE_PROJECT_ID || parsed.projectId,
  storageBucket: parsed.FIREBASE_STORAGE_BUCKET || parsed.storageBucket,
  messagingSenderId: parsed.FIREBASE_MESSAGING_SENDER_ID || parsed.messagingSenderId,
  appId: parsed.FIREBASE_APP_ID || parsed.appId,
  measurementId: parsed.FIREBASE_MEASUREMENT_ID || parsed.measurementId
};

const missing = Object.keys(map).filter(k => !map[k]);
if (missing.length) {
  console.warn('Warning: missing keys in parsed .env:', missing.join(', '));
}

const outDir = path.dirname(outPath);
if (!fs.existsSync(outDir)) fs.mkdirSync(outDir, { recursive: true });

const content = `// Generated by scripts/generate-firebase-config.js - DO NOT COMMIT\nwindow.__FIREBASE_CONFIG__ = {\n  apiKey: ${map.apiKey ? JSON.stringify(map.apiKey) : '""'},\n  authDomain: ${map.authDomain ? JSON.stringify(map.authDomain) : '""'},\n  projectId: ${map.projectId ? JSON.stringify(map.projectId) : '""'},\n  storageBucket: ${map.storageBucket ? JSON.stringify(map.storageBucket) : '""'},\n  messagingSenderId: ${map.messagingSenderId ? JSON.stringify(map.messagingSenderId) : '""'},\n  appId: ${map.appId ? JSON.stringify(map.appId) : '""'},\n  measurementId: ${map.measurementId ? JSON.stringify(map.measurementId) : '""'}\n};\n`;

fs.writeFileSync(outPath, content, 'utf8');
console.log('Wrote', outPath);
if (missing.length) process.exitCode = 0;
